<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacChain API ì•„í‚¤í…ì²˜ ì‹œê°í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .feature-card h3 {
            color: #3498db;
            margin-top: 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .directory-tree {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            overflow-x: auto;
        }
        .directory-tree .file {
            color: #3498db;
        }
        .directory-tree .dir {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ï¸ MacChain API ì•„í‚¤í…ì²˜ ì‹œê°í™”</h1>

    <div class="info-box">
        <strong>ğŸ“Œ ê°œìš”:</strong> MacChain Bible Appì˜ Cloudflare Workers ê¸°ë°˜ API ì„œë²„ ì•„í‚¤í…ì²˜ë¥¼ ì‹œê°í™”í•œ ë¬¸ì„œì…ë‹ˆë‹¤.
    </div>

    <h2>ğŸ“ ì „ì²´ ì•„í‚¤í…ì²˜</h2>
    
    <h3>ê°„ë‹¨í•œ êµ¬ì¡°ë„</h3>
    <div class="mermaid">
        graph LR
            A[Client] -->|HTTP Request| B[Cloudflare Workers]
            B --> C[Router]
            C --> D[Middleware]
            D --> E[Handler]
            E --> F[Utils]
            E --> G[Database]
            E --> H[AI]
            F --> I[Response]
            I -->|HTTP Response| A
    </div>

    <h3>ìƒì„¸ ë ˆì´ì–´ êµ¬ì¡°</h3>
    <div class="mermaid">
        graph TD
            A[Client Request] --> B[Entry Point<br/>fetch handler]
            B --> C[Router<br/>Worktop]
            
            C -->|Public| D1[Health Handler]
            C -->|Protected| D2[Auth Middleware]
            
            D2 -->|Valid| E[API Handlers]
            D2 -->|Invalid| F[401 Response]
            
            E --> G[Validator]
            E --> H[Logger]
            E --> I[Database]
            E --> J[AI Service]
            
            G --> K[Response Wrapper]
            H --> K
            I --> K
            J --> K
            
            K --> L[Client Response]
            F --> L
            D1 --> L
    </div>

    <h3>ë ˆì´ì–´ë³„ êµ¬ì„± ìš”ì†Œ</h3>
    <div class="mermaid">
        graph TB
            subgraph L1["1ï¸âƒ£ Entry Layer"]
                E1[fetch handler]
            end
            
            subgraph L2["2ï¸âƒ£ Router Layer"]
                R1[Worktop Router]
                R2[Route Matching]
            end
            
            subgraph L3["3ï¸âƒ£ Middleware Layer"]
                M1[Auth Middleware]
            end
            
            subgraph L4["4ï¸âƒ£ Handler Layer"]
                H1[Auth API]
                H2[Users API]
                H3[Reading Plan API]
                H4[Statistics API]
                H5[AI Analysis API]
                H6[Consent API]
            end
            
            subgraph L5["5ï¸âƒ£ Utility Layer"]
                U1[Validator]
                U2[Response Wrapper]
                U3[Logger]
                U4[JWT Utils]
                U5[Password Utils]
            end
            
            subgraph L6["6ï¸âƒ£ Data Layer"]
                D1[D1 Database]
                D2[Cloudflare AI]
            end
            
            L1 --> L2
            L2 --> L3
            L3 --> L4
            L4 --> L5
            L4 --> L6
            L5 --> L1
    </div>

    <h2>ğŸ”„ ìš”ì²­ ì²˜ë¦¬ íë¦„</h2>
    
    <h3>ë‹¨ê³„ë³„ íë¦„</h3>
    <div class="mermaid">
        flowchart TD
            Start([Client Request]) --> Step1[1. Entry Point<br/>HTTP ìš”ì²­ ìˆ˜ì‹ ]
            Step1 --> Step2[2. Router<br/>ê²½ë¡œ ë§¤ì¹­]
            
            Step2 -->|Public| Step3A[3A. Public Handler<br/>Health Check]
            Step2 -->|Protected| Step3B[3B. Auth Check<br/>JWT ê²€ì¦]
            
            Step3B -->|ì‹¤íŒ¨| Error1[401 Unauthorized]
            Step3B -->|ì„±ê³µ| Step4[4. Handler ì‹¤í–‰]
            Step3A --> Step4
            
            Step4 --> Step5[5. ë°ì´í„° ê²€ì¦]
            Step5 -->|ì‹¤íŒ¨| Error2[400 Validation Error]
            Step5 -->|ì„±ê³µ| Step6[6. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§]
            
            Step6 --> Step7[7. Database/AI í˜¸ì¶œ]
            Step7 --> Step8[8. ì‘ë‹µ ìƒì„±]
            Step8 --> Step9[9. ë¡œê¹…]
            Step9 --> End([Client Response])
            
            Error1 --> End
            Error2 --> End
    </div>

    <h3>ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨</h3>
    <div class="mermaid">
        sequenceDiagram
            participant C as Client
            participant R as Router
            participant M as Middleware
            participant H as Handler
            participant D as Database
            participant Res as Response

            C->>R: HTTP Request
            R->>M: Check Auth (if needed)
            M->>H: Continue
            H->>H: Validate Data
            H->>D: Query
            D->>H: Result
            H->>Res: Format Response
            Res->>C: HTTP Response
    </div>

    <h2>ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°</h2>
    <div class="directory-tree">
backend/cloudflare-workers/
â”‚
â”œâ”€â”€ <span class="dir">api/</span>                          # API í•¸ë“¤ëŸ¬ ë ˆì´ì–´
â”‚   â”œâ”€â”€ <span class="file">index-worktop.js</span>          # ë©”ì¸ ë¼ìš°í„° (Worktop)
â”‚   â”œâ”€â”€ <span class="file">auth-worktop.js</span>           # ì¸ì¦ API
â”‚   â”œâ”€â”€ <span class="file">users-worktop.js</span>          # ì‚¬ìš©ì ê´€ë¦¬ API
â”‚   â”œâ”€â”€ <span class="file">reading-plan-worktop.js</span>   # ì½ê¸° ê³„íš API
â”‚   â”œâ”€â”€ <span class="file">statistics-worktop.js</span>     # í†µê³„ API
â”‚   â”œâ”€â”€ <span class="file">ai-analysis-worktop.js</span>    # AI ë¶„ì„ API
â”‚   â”œâ”€â”€ <span class="file">consent-worktop.js</span>        # ë™ì˜ ê´€ë¦¬ API
â”‚   â””â”€â”€ <span class="file">health-worktop.js</span>         # í—¬ìŠ¤ì²´í¬ API
â”‚
â”œâ”€â”€ <span class="dir">middleware/</span>                    # ë¯¸ë“¤ì›¨ì–´ ë ˆì´ì–´
â”‚   â””â”€â”€ <span class="file">auth.js</span>                   # ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
â”‚       â”œâ”€â”€ authMiddleware()      # í•„ìˆ˜ ì¸ì¦
â”‚       â””â”€â”€ optionalAuthMiddleware() # ì„ íƒì  ì¸ì¦
â”‚
â”œâ”€â”€ <span class="dir">utils/</span>                         # ìœ í‹¸ë¦¬í‹° ë ˆì´ì–´
â”‚   â”œâ”€â”€ <span class="file">jwt.js</span>                    # JWT í† í° ê´€ë¦¬
â”‚   â”œâ”€â”€ <span class="file">password.js</span>               # ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”
â”‚   â”œâ”€â”€ <span class="file">logger.js</span>                 # êµ¬ì¡°í™”ëœ ë¡œê¹…
â”‚   â”œâ”€â”€ <span class="file">response.js</span>               # í‘œì¤€í™”ëœ ì‘ë‹µ ë˜í¼
â”‚   â””â”€â”€ <span class="file">validator.js</span>              # ë°ì´í„° ê²€ì¦
â”‚
â””â”€â”€ <span class="dir">database/</span>                      # ë°ì´í„°ë² ì´ìŠ¤ ë ˆì´ì–´
    â”œâ”€â”€ <span class="file">schema.sql</span>                 # D1 ìŠ¤í‚¤ë§ˆ
    â””â”€â”€ <span class="file">sample-data.sql</span>           # ìƒ˜í”Œ ë°ì´í„°
    </div>

    <h2>ğŸ§© í•µì‹¬ ì»´í¬ë„ŒíŠ¸</h2>
    <div class="feature-list">
        <div class="feature-card">
            <h3>ğŸ” ì¸ì¦ ë¯¸ë“¤ì›¨ì–´</h3>
            <p><strong>ìœ„ì¹˜:</strong> <code>middleware/auth.js</code></p>
            <ul>
                <li>JWT í† í° ê²€ì¦</li>
                <li>ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ</li>
                <li>ì¸ì¦ ì‹¤íŒ¨ ì‹œ ìë™ ì‘ë‹µ</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>ğŸ“¦ ì‘ë‹µ ë˜í¼</h3>
            <p><strong>ìœ„ì¹˜:</strong> <code>utils/response.js</code></p>
            <ul>
                <li>í‘œì¤€í™”ëœ ì‘ë‹µ í˜•ì‹</li>
                <li>ì„±ê³µ/ì—ëŸ¬ ì‘ë‹µ í—¬í¼</li>
                <li>ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>ğŸ“ ë¡œê¹… ì‹œìŠ¤í…œ</h3>
            <p><strong>ìœ„ì¹˜:</strong> <code>utils/logger.js</code></p>
            <ul>
                <li>êµ¬ì¡°í™”ëœ JSON ë¡œê·¸</li>
                <li>ì»¨í…ìŠ¤íŠ¸ë³„ ë¡œê±°</li>
                <li>ìš”ì²­/ì‘ë‹µ ìë™ ë¡œê¹…</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>âœ… ê²€ì¦ ìœ í‹¸ë¦¬í‹°</h3>
            <p><strong>ìœ„ì¹˜:</strong> <code>utils/validator.js</code></p>
            <ul>
                <li>ì²´ì´ë‹ ê°€ëŠ¥í•œ ê²€ì¦</li>
                <li>ì¼ë°˜ì ì¸ ê²€ì¦ ê·œì¹™</li>
                <li>ì»¤ìŠ¤í…€ ê²€ì¦ ì§€ì›</li>
            </ul>
        </div>
    </div>

    <h2>ğŸ¯ API ì—”ë“œí¬ì¸íŠ¸ ë§µ</h2>
    <div class="mermaid">
        mindmap
          root((MacChain API))
            Auth
              POST /api/auth/login
              POST /api/auth/register
              POST /api/auth/verify
            Users
              GET /api/users/profile
              PUT /api/users/profile
              GET /api/users/:userId/progress
              PUT /api/users/:userId/progress
            Reading Plan
              GET /api/mccheyne/today
              GET /api/mccheyne/:date/progress
              PUT /api/mccheyne/:date/progress
            Statistics
              GET /api/statistics/user
            AI Analysis
              POST /api/ai/analyze
            Consent
              GET /api/consent
              PUT /api/consent
            Health
              GET /api/health
    </div>

    <h2>ğŸ” ì¸ì¦ íë¦„</h2>
    <div class="mermaid">
        sequenceDiagram
            participant C as Client
            participant A as Auth Handler
            participant V as Validator
            participant P as Password Utils
            participant J as JWT Utils
            participant D as Database
            participant R as Response

            Note over C,R: íšŒì›ê°€ì… (Register)
            C->>A: POST /api/auth/register
            A->>V: Validate email, password, name, nickname
            V->>A: Validation Result
            A->>D: Check email exists
            D->>A: User exists?
            alt Email exists
                A->>R: 409 Conflict
            else Email not exists
                A->>P: Hash password
                P->>A: Hashed password
                A->>D: Insert user
                D->>A: User ID
                A->>J: Generate JWT
                J->>A: Token
                A->>R: 201 Created + Token
            end
            R->>C: Response
    </div>

    <h2>ğŸ›¡ï¸ ë³´ì•ˆ ê³„ì¸µ</h2>
    <div class="mermaid">
        graph TD
            subgraph "Security Layers"
                L1[Layer 1: CORS] --> L2[Layer 2: Authentication]
                L2 --> L3[Layer 3: Authorization]
                L3 --> L4[Layer 4: Input Validation]
                L4 --> L5[Layer 5: SQL Injection Prevention]
                L5 --> L6[Layer 6: Password Hashing]
            end
            
            L1 -->|Origin Check| C1[Allowed Origins]
            L2 -->|JWT Verify| C2[Token Validation]
            L3 -->|User Check| C3[Resource Ownership]
            L4 -->|Data Check| C4[Type & Format]
            L5 -->|Query Check| C5[Prepared Statements]
            L6 -->|Password Check| C6[SHA-256 + Salt]
    </div>

    <div class="info-box">
        <strong>ğŸ“š ì°¸ê³ :</strong> ì´ ë¬¸ì„œëŠ” Mermaid ë‹¤ì´ì–´ê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
        GitHubë‚˜ Mermaidë¥¼ ì§€ì›í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë·°ì–´ì—ì„œ ìë™ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>

