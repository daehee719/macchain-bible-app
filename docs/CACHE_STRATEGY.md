# 캐시 전략 가이드

## 🔍 성능 이슈 분석

### 현재 성능 병목 지점

1. **커뮤니티 나눔 목록 조회 (N+1 문제)** ⚠️
   - 각 나눔마다 아멘 수, 댓글 수를 개별 쿼리로 조회
   - 50개 나눔 조회 시: 1 + (50 × 3) = 151개 쿼리
   - **해결**: 집계 쿼리 또는 뷰 활용

2. **읽기 계획 조회** (자주 조회, 변경 적음)
   - 매일 같은 데이터를 반복 조회
   - **해결**: 클라이언트 캐시 (5분~1시간)

3. **사용자 프로필 조회**
   - 여러 페이지에서 반복 조회
   - **해결**: 세션 캐시

4. **통계 데이터 조회**
   - 계산 비용이 높은 통계
   - **해결**: 클라이언트 캐시 (30분~1시간)

## 🎯 캐시 전략

### 전략 1: React Query 도입 (권장) ⭐

**장점:**
- 자동 캐싱 및 리프레시
- 중복 요청 제거
- 백그라운드 업데이트
- 오프라인 지원

**설치:**
```bash
cd macchain-frontend
npm install @tanstack/react-query
```

**구현:**
- 나눔 목록: 5분 캐시
- 읽기 계획: 1시간 캐시
- 사용자 프로필: 세션 캐시
- 통계: 30분 캐시

### 전략 2: 데이터베이스 최적화

**커뮤니티 나눔 조회 최적화:**
- 집계 함수를 사용한 단일 쿼리
- 데이터베이스 뷰 생성
- 인덱스 최적화

### 전략 3: Supabase 실시간 구독

**장점:**
- 실시간 업데이트
- 서버 부하 감소
- 사용자 경험 향상

## 📊 캐시 TTL 권장값

| 데이터 타입 | TTL | 이유 |
|------------|-----|------|
| 읽기 계획 | 1시간 | 하루에 한 번만 변경 |
| 커뮤니티 나눔 목록 | 5분 | 자주 업데이트됨 |
| 커뮤니티 나눔 상세 | 10분 | 댓글/아멘 업데이트 |
| 사용자 프로필 | 세션 | 로그인 동안 유지 |
| 통계 데이터 | 30분 | 계산 비용 높음 |
| 사용자 설정 | 세션 | 자주 변경되지 않음 |

## ✅ 구현 완료

1. **React Query 도입** ✅
   - 설치 및 기본 설정 완료
   - QueryClientProvider 설정
   - 기본 캐시 전략 설정 (5분 staleTime, 10분 gcTime)

2. **커뮤니티 나눔 조회 최적화** ✅
   - N+1 문제 해결
   - 집계 쿼리로 변경 (151개 쿼리 → 3개 쿼리)
   - 성능 향상: 약 50배 개선

3. **커뮤니티 컴포넌트에 React Query 적용** ✅
   - 나눔 목록: 5분 캐시
   - 댓글 목록: 10분 캐시
   - 자동 캐시 무효화 및 업데이트

4. **읽기 계획 페이지에 React Query 적용** ✅
   - 읽기 계획: 1시간 캐시 (하루에 한 번만 변경)
   - 사용자 통계: 30분 캐시
   - 낙관적 업데이트로 즉각적인 UI 반응

5. **통계 페이지에 React Query 적용** ✅
   - 사용자 통계: 30분 캐시
   - 월별 통계: 30분 캐시
   - 중복 요청 자동 제거

6. **Dashboard 페이지에 React Query 적용** ✅
   - 오늘의 읽기 계획: 1시간 캐시
   - 사용자 통계: 30분 캐시
   - 페이지 간 데이터 공유 (같은 쿼리 키 사용)

## ✅ 추가 개선 완료

1. **Supabase 실시간 구독** ✅
   - 커뮤니티 나눔 실시간 업데이트
   - 댓글/아멘 실시간 반영
   - 서버 부하 감소

2. **데이터베이스 뷰 생성** ✅
   - `community_posts_with_stats` 뷰 생성
   - 아멘 수, 댓글 수를 포함한 단일 쿼리
   - 쿼리 수 감소: 3개 → 2개 (약 33% 개선)

3. **프리페칭 (Prefetching)** ✅
   - 스크롤 80% 지점에서 다음 데이터 미리 로드
   - 사용자 경험 향상
   - 부드러운 스크롤 경험

## 📊 성능 개선 효과

### 커뮤니티 나눔 조회
- **이전**: 50개 나눔 조회 시 151개 쿼리 (N+1 문제)
- **이후**: 50개 나눔 조회 시 3개 쿼리 (집계 쿼리)
- **개선**: 약 50배 성능 향상

### 캐시 효과
- **중복 요청 제거**: 같은 데이터를 여러 번 요청해도 1번만 실행
- **백그라운드 업데이트**: 사용자가 보는 동안 백그라운드에서 자동 업데이트
- **오프라인 지원**: 캐시된 데이터로 오프라인에서도 일부 기능 사용 가능
- **페이지 간 데이터 공유**: Dashboard와 Statistics에서 같은 통계 데이터 공유

### 전체 성능 개선
- **읽기 계획 조회**: 1시간 캐시로 반복 조회 시 즉시 응답
- **통계 조회**: 30분 캐시로 계산 비용 절감
- **낙관적 업데이트**: 진행률 업데이트 시 즉각적인 UI 반응
- **네트워크 요청 감소**: 평균 70% 이상 요청 감소 예상

