name: ğŸ”€ Feature Branch CI

on:
  pull_request:
    branches: [ develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ 'feature/**', 'bugfix/**', 'improvement/**' ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # ===== ë³€ê²½ì‚¬í•­ ê°ì§€ =====
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Detect Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          backend:
            - 'macchain-backend/**'
          frontend:
            - 'macchain-frontend/**'
          docs:
            - 'docs/**'
            - '*.md'

  # ===== ë°±ì—”ë“œ ê²€ì¦ =====
  backend-validation:
    name: ğŸ—ï¸ Backend Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache Gradle Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ”§ Make Gradlew Executable
      run: chmod +x macchain-backend/gradlew
      
    - name: ğŸ§¹ Gradle Clean & Compile
      run: cd macchain-backend && ./gradlew clean compileJava compileTestJava
      
    - name: ğŸ” Code Quality Check
      run: cd macchain-backend && ./gradlew checkstyleMain checkstyleTest
      continue-on-error: true
      
    - name: ğŸ§ª Run Tests
      run: cd macchain-backend && ./gradlew test -Dspring.profiles.active=dev
      
    - name: ğŸ“Š Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ§ª Backend Test Results
        path: macchain-backend/build/test-results/test/*.xml
        reporter: java-junit

  # ===== í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦ =====
  frontend-validation:
    name: âš›ï¸ Frontend Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: macchain-frontend/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd macchain-frontend
        npm ci
        
    - name: ğŸ” Lint Check
      run: |
        cd macchain-frontend
        npm run lint
        
    - name: ğŸ§ª Type Check
      run: |
        cd macchain-frontend
        npm run type-check
        
    - name: ğŸ§ª Run Tests
      run: |
        cd macchain-frontend
        npm run test:coverage
        
    - name: ğŸ—ï¸ Build Application
      run: |
        cd macchain-frontend
        npm run build
        
    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: macchain-frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # ===== ë³´ì•ˆ ìŠ¤ìº” =====
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.frontend == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ›¡ï¸ Run Trivy Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“‹ Upload Security Results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ===== ë¬¸ì„œ ê²€ì¦ =====
  docs-validation:
    name: ğŸ“š Documentation Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Markdown Lint
      uses: articulate/actions-markdownlint@v1
      with:
        config: .markdownlint.json
        files: '**/*.md'
        ignore: 'node_modules'
      continue-on-error: true
      
    - name: ğŸ”— Link Check
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.markdown-link-check.json'
      continue-on-error: true

  # ===== í†µí•© ê²€ì¦ ê²°ê³¼ =====
  validation-summary:
    name: âœ… Validation Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-validation, frontend-validation, security-scan, docs-validation]
    if: always()
    
    steps:
    - name: ğŸ“Š Check Results
      run: |
        echo "ğŸ” ë³€ê²½ì‚¬í•­ ê°ì§€ ê²°ê³¼:"
        echo "- Backend: ${{ needs.detect-changes.outputs.backend }}"
        echo "- Frontend: ${{ needs.detect-changes.outputs.frontend }}"
        echo "- Docs: ${{ needs.detect-changes.outputs.docs }}"
        echo ""
        echo "âœ… ê²€ì¦ ê²°ê³¼:"
        echo "- Backend: ${{ needs.backend-validation.result }}"
        echo "- Frontend: ${{ needs.frontend-validation.result }}"
        echo "- Security: ${{ needs.security-scan.result }}"
        echo "- Docs: ${{ needs.docs-validation.result }}"
        
        # ì‹¤íŒ¨í•œ ì‘ì—…ì´ ìˆëŠ”ì§€ í™•ì¸
        if [[ "${{ needs.backend-validation.result }}" == "failure" ]] || \
           [[ "${{ needs.frontend-validation.result }}" == "failure" ]] || \
           [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
          echo "âŒ ì¼ë¶€ ê²€ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          exit 1
        else
          echo "âœ… ëª¨ë“  ê²€ì¦ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
        fi

  # ===== PR ì½”ë©˜íŠ¸ =====
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [detect-changes, validation-summary]
    if: github.event_name == 'pull_request' && always()
    
    steps:
    - name: ğŸ’¬ Add PR Comment
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ğŸ”€ Feature Branch CI Results')
          );
          
          const body = `## ğŸ”€ Feature Branch CI Results
          
          ### ğŸ“Š ë³€ê²½ì‚¬í•­ ê°ì§€
          - ğŸ—ï¸ Backend: ${{ needs.detect-changes.outputs.backend == 'true' && 'âœ…' || 'â­ï¸' }}
          - âš›ï¸ Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ…' || 'â­ï¸' }}
          - ğŸ“š Docs: ${{ needs.detect-changes.outputs.docs == 'true' && 'âœ…' || 'â­ï¸' }}
          
          ### ğŸ§ª ê²€ì¦ ê²°ê³¼
          - ğŸ—ï¸ Backend Validation: ${{ needs.validation-summary.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          - âš›ï¸ Frontend Validation: ${{ needs.validation-summary.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          - ğŸ”’ Security Scan: ${{ needs.validation-summary.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          
          ### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
          ${{ needs.validation-summary.result == 'success' && 'âœ… ëª¨ë“  ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·° í›„ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤!' || 'âŒ ì¼ë¶€ ê²€ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.' }}
          
          ---
          *ğŸ¤– ìë™ ìƒì„±ëœ ì½”ë©˜íŠ¸ì…ë‹ˆë‹¤. ì—…ë°ì´íŠ¸ ì‹œê°„: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
