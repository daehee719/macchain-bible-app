name: â˜ï¸ Cloudflare Full-Stack Deploy

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/cloudflare-workers/**'
      - 'frontend/**'
      - '.github/workflows/cloudflare-deploy.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/cloudflare-workers/**'
      - 'frontend/**'
  workflow_dispatch:

jobs:
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.changes.outputs.workers }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” Check Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          workers:
            - 'backend/cloudflare-workers/**'
          frontend:
            - 'frontend/**'

  deploy-workers:
    name: âš¡ Deploy Workers
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.workers == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/cloudflare-workers/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend/cloudflare-workers
        npm ci
        
    - name: ğŸ” Lint Code
      run: |
        cd backend/cloudflare-workers
        npm run lint || echo "Lint skipped"
        
    - name: ğŸ§ª Run Tests
      run: |
        cd backend/cloudflare-workers
        npm run test || echo "Tests skipped"
        
    - name: ğŸš€ Deploy Workers
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: deploy
        workingDirectory: backend/cloudflare-workers
        
    - name: ğŸ—„ï¸ Deploy D1 Database
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: d1 migrations apply macchain-db
        workingDirectory: cloudflare-workers

  deploy-pages:
    name: ğŸŒ Deploy Pages
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ” Lint Code
      run: |
        cd frontend
        npm run lint || echo "Lint skipped"
        
    - name: ğŸ§ª Run Tests
      run: |
        cd frontend
        npm run test || echo "Tests skipped"
    - name: ğŸ—ï¸ Build CSS
      run: |
        cd frontend
        npm run css:build

    - name: ğŸ—ï¸ Build Application
      run: |
        cd frontend
        npm run build
        
    - name: ğŸŒ Deploy to Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: macchain-frontend
        directory: frontend/dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: ğŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [deploy-workers, deploy-pages]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Status
      run: |
        echo "ğŸš€ Cloudflare ë°°í¬ ì™„ë£Œ!"
        echo "Workers: ${{ needs.deploy-workers.result }}"
        echo "Pages: ${{ needs.deploy-pages.result }}"
