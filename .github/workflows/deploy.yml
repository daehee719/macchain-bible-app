name: ðŸš€ Full Stack Deployment

on:
  workflow_run:
    workflows: ["ðŸ“‹ Backend CI/CD", "âš›ï¸ Frontend CI/CD Pipeline"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  DOCKER_REGISTRY: docker.io
  PROJECT_NAME: macchain

jobs:
  # ===== ë°°í¬ ì¤€ë¹„ =====
  prepare-deployment:
    name: ðŸ“‹ Prepare Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      backend-image: ${{ steps.set-env.outputs.backend-image }}
      frontend-image: ${{ steps.set-env.outputs.frontend-image }}
      
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Set Environment
      id: set-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=production" >> $GITHUB_OUTPUT
        fi
        
        echo "backend-image=${{ secrets.DOCKER_USERNAME }}/macchain-backend:latest" >> $GITHUB_OUTPUT
        echo "frontend-image=${{ secrets.DOCKER_USERNAME }}/macchain-frontend:latest" >> $GITHUB_OUTPUT

  # ===== ì¸í”„ë¼ ë°°í¬ =====
  deploy-infrastructure:
    name: ðŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: prepare-deployment
    environment: ${{ needs.prepare-deployment.outputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
        
    - name: ðŸ—ï¸ Terraform Init
      run: |
        cd infrastructure/terraform
        terraform init
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
    - name: ðŸ“‹ Terraform Plan
      run: |
        cd infrastructure/terraform
        terraform plan -var="environment=${{ needs.prepare-deployment.outputs.environment }}"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
    - name: ðŸš€ Terraform Apply
      if: needs.prepare-deployment.outputs.environment == 'production'
      run: |
        cd infrastructure/terraform
        terraform apply -auto-approve -var="environment=${{ needs.prepare-deployment.outputs.environment }}"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ===== ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ =====
  database-migration:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-infrastructure]
    environment: ${{ needs.prepare-deployment.outputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ—„ï¸ Run Database Migration
      run: |
        cd macchain-backend
        ./gradlew flywayMigrate -Dspring.profiles.active=prod
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

  # ===== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ =====
  deploy-application:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [prepare-deployment, database-migration]
    environment: ${{ needs.prepare-deployment.outputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Compose
      run: |
        # Docker Compose í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        cat > .env << EOF
        ENVIRONMENT=${{ needs.prepare-deployment.outputs.environment }}
        BACKEND_IMAGE=${{ needs.prepare-deployment.outputs.backend-image }}
        FRONTEND_IMAGE=${{ needs.prepare-deployment.outputs.frontend-image }}
        
        # Database
        POSTGRES_HOST=${{ secrets.DB_HOST }}
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USERNAME }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # MongoDB
        MONGODB_HOST=${{ secrets.MONGODB_HOST }}
        MONGODB_PORT=${{ secrets.MONGODB_PORT }}
        MONGODB_DB=${{ secrets.MONGODB_DB }}
        
        # Redis
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        
        # OpenAI
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        
        # JWT
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOF
        
    - name: ðŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /opt/macchain
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git pull origin main
          
          # Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          docker-compose pull
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ìž¬ì‹œìž‘
          docker-compose down
          docker-compose up -d
          
          # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
          docker system prune -f

  # ===== ë°°í¬ ê²€ì¦ =====
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-application]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ¥ Health Check - Backend
      run: |
        echo "ðŸ” ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
        for i in {1..30}; do
          if curl -f ${{ secrets.BACKEND_URL }}/api/health; then
            echo "âœ… ë°±ì—”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤!"
            break
          fi
          echo "â³ ë°±ì—”ë“œ ì‹œìž‘ ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 10
        done
        
    - name: ðŸ¥ Health Check - Frontend
      run: |
        echo "ðŸ” í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
        for i in {1..30}; do
          if curl -f ${{ secrets.FRONTEND_URL }}; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤!"
            break
          fi
          echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì‹œìž‘ ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 10
        done
        
    - name: ðŸ§ª Smoke Tests
      run: |
        echo "ðŸ§ª ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        curl -f ${{ secrets.BACKEND_URL }}/api/mccheyne/today
        curl -f ${{ secrets.BACKEND_URL }}/api/health
        
        # í”„ë¡ íŠ¸ì—”ë“œ íŽ˜ì´ì§€ í…ŒìŠ¤íŠ¸
        curl -f ${{ secrets.FRONTEND_URL }}/
        
        echo "âœ… ëª¨ë“  ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"

  # ===== ë¡¤ë°± ì¤€ë¹„ =====
  prepare-rollback:
    name: ðŸ”„ Prepare Rollback
    runs-on: ubuntu-latest
    needs: [verify-deployment]
    if: failure()
    
    steps:
    - name: ðŸš¨ Deployment Failed - Preparing Rollback
      run: |
        echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡¤ë°±ì„ ì¤€ë¹„í•©ë‹ˆë‹¤..."
        
    - name: ðŸ”„ Execute Rollback
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          cd /opt/macchain
          
          # ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
          docker-compose down
          git checkout HEAD~1
          docker-compose up -d
          
          echo "ðŸ”„ ë¡¤ë°±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

  # ===== ë°°í¬ ì™„ë£Œ ì•Œë¦¼ =====
  notify-completion:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [prepare-deployment, verify-deployment]
    if: always()
    
    steps:
    - name: ðŸ“§ Send Success Notification
      if: needs.verify-deployment.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#macchain-deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          ðŸŽ‰ **MacChain ë°°í¬ ì„±ê³µ!**
          
          **í™˜ê²½**: ${{ needs.prepare-deployment.outputs.environment }}
          **ë°±ì—”ë“œ**: ${{ needs.prepare-deployment.outputs.backend-image }}
          **í”„ë¡ íŠ¸ì—”ë“œ**: ${{ needs.prepare-deployment.outputs.frontend-image }}
          
          **URL**: 
          - ðŸŒ Frontend: ${{ secrets.FRONTEND_URL }}
          - ðŸ”§ Backend: ${{ secrets.BACKEND_URL }}
          
    - name: ðŸ“§ Send Failure Notification
      if: needs.verify-deployment.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#macchain-deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          ðŸš¨ **MacChain ë°°í¬ ì‹¤íŒ¨!**
          
          **í™˜ê²½**: ${{ needs.prepare-deployment.outputs.environment }}
          **ì‹¤íŒ¨ ë‹¨ê³„**: ë°°í¬ ê²€ì¦
          
          ë¡¤ë°±ì´ ìžë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
