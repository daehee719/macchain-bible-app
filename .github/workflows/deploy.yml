name: ğŸš€ Full Stack Deployment

on:
  workflow_run:
    workflows: ["ğŸ“‹ Backend CI/CD", "âš›ï¸ Frontend CI/CD Pipeline"]
    branches: [main, develop]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  DOCKER_REGISTRY: docker.io
  PROJECT_NAME: macchain

jobs:
  # ===== ë°°í¬ ì¤€ë¹„ =====
  prepare-deployment:
    name: ğŸ“‹ Prepare Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      backend-image: ${{ steps.set-env.outputs.backend-image }}
      frontend-image: ${{ steps.set-env.outputs.frontend-image }}
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Set Environment
      id: set-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=production" >> $GITHUB_OUTPUT
        fi
        
        echo "backend-image=${{ secrets.DOCKER_USERNAME }}/macchain-backend:latest" >> $GITHUB_OUTPUT
        echo "frontend-image=${{ secrets.DOCKER_USERNAME }}/macchain-frontend:latest" >> $GITHUB_OUTPUT

  # ===== ì¸í”„ë¼ ë°°í¬ (í˜„ì¬ ë¹„í™œì„±í™”) =====
  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure (Skipped)
    runs-on: ubuntu-latest
    needs: prepare-deployment
    if: false  # ì¸í”„ë¼ ì„¤ì •ì´ ì—†ì–´ì„œ ë¹„í™œì„±í™”
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â­ï¸ Infrastructure Deployment Skipped
      run: echo "ì¸í”„ë¼ ë°°í¬ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. AWS/Terraform ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."

  # ===== ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (í˜„ì¬ ë¹„í™œì„±í™”) =====
  database-migration:
    name: ğŸ—„ï¸ Database Migration (Skipped)
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-infrastructure]
    if: false  # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì´ ì—†ì–´ì„œ ë¹„í™œì„±í™”
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â­ï¸ Database Migration Skipped
      run: echo "ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. DB ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."

  # ===== Docker ì´ë¯¸ì§€ ë¹Œë“œ =====
  build-images:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: prepare-deployment
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ—ï¸ Build and Push Backend Image
      uses: docker/build-push-action@v5
      with:
        context: ./macchain-backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/macchain-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ¨ Build and Push Frontend Image
      uses: docker/build-push-action@v5
      with:
        context: ./macchain-frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/macchain-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ =====
  deploy-application:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [prepare-deployment, build-images]
    if: ${{ secrets.DEPLOY_HOST != '' }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“‹ Copy Deployment Files
      run: |
        mkdir -p deployment
        cp docker-compose.prod.yml deployment/
        cp scripts/deploy.sh deployment/
        
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/macchain
          sudo chown $USER:$USER /opt/macchain
          cd /opt/macchain
          
          # Git ì €ì¥ì†Œ í´ë¡  (ì²˜ìŒë§Œ)
          if [ ! -d ".git" ]; then
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          
          # ë°°í¬ íŒŒì¼ ë³µì‚¬
          cp deployment/docker-compose.prod.yml .
          cp deployment/deploy.sh .
          chmod +x deploy.sh
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export BACKEND_IMAGE=${{ secrets.DOCKER_USERNAME }}/macchain-backend:latest
          export FRONTEND_IMAGE=${{ secrets.DOCKER_USERNAME }}/macchain-frontend:latest
          export FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # ë°°í¬ ì‹¤í–‰
          ./deploy.sh

  # ===== ë°°í¬ ê²€ì¦ =====
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-application]
    if: ${{ secrets.DEPLOY_HOST != '' }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¥ Health Check - Backend
      run: |
        echo "ğŸ” ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
        for i in {1..30}; do
          if curl -f ${{ secrets.BACKEND_URL }}/actuator/health; then
            echo "âœ… ë°±ì—”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
            break
          fi
          echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 10
        done
        
    - name: ğŸ¥ Health Check - Frontend
      run: |
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
        for i in {1..30}; do
          if curl -f ${{ secrets.FRONTEND_URL }}; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
            break
          fi
          echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 10
        done
        
    - name: ğŸ§ª Smoke Tests
      run: |
        echo "ğŸ§ª ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        curl -f ${{ secrets.BACKEND_URL }}/api/health
        curl -f ${{ secrets.BACKEND_URL }}/api/mccheyne/today
        
        # í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
        curl -f ${{ secrets.FRONTEND_URL }}/
        
        echo "âœ… ëª¨ë“  ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"

  # ===== ë¡¤ë°± ì¤€ë¹„ (í˜„ì¬ ë¹„í™œì„±í™”) =====
  prepare-rollback:
    name: ğŸ”„ Prepare Rollback (Skipped)
    runs-on: ubuntu-latest
    needs: [verify-deployment]
    if: false  # ë°°í¬ê°€ ë¹„í™œì„±í™”ë˜ì–´ì„œ ë¡¤ë°±ë„ ë¹„í™œì„±í™”
    
    steps:
    - name: â­ï¸ Rollback Skipped
      run: echo "ë¡¤ë°±ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë°°í¬ê°€ í™œì„±í™”ë˜ë©´ ìë™ ë¡¤ë°±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."

  # ===== ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (í˜„ì¬ ë¹„í™œì„±í™”) =====
  notify-completion:
    name: ğŸ“¢ Deployment Notification (Skipped)
    runs-on: ubuntu-latest
    needs: [prepare-deployment, verify-deployment]
    if: false  # ë°°í¬ê°€ ë¹„í™œì„±í™”ë˜ì–´ì„œ ì•Œë¦¼ë„ ë¹„í™œì„±í™”
    
    steps:
    - name: â­ï¸ Notification Skipped
      run: |
        echo "ë°°í¬ ì•Œë¦¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        echo "Slack ì›¹í›… ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤: SLACK_WEBHOOK"
